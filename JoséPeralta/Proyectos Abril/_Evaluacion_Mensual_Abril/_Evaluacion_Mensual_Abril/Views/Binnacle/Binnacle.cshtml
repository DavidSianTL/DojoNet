@model _Evaluacion_Mensual_Abril.Models.Binnacle.BinnaclePageViewModel
@{
    ViewBag.Title = "Bitácora de Actividades";
}

<div class="products-page mt-4 animation-global">
    <!-- Botón Volver -->
    <div class="mb-4">
        <a class="btn btn-primary" href="@Url.Action("Index", "Home")">
            <i class="fas fa-arrow-left me-1"></i> Volver al Inicio
        </a>
    </div>

    <!-- Título -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h2 class="mb-0">Bitácora de Actividades</h2>
        </div>
        <div class="card-body">
            <!-- Formulario para agregar entrada -->
            <form id="formAgregarLog" asp-action="Agregar" method="post" class="mb-4">
                <div class="row">
                    <div class="col-md-5 mb-3">
                        <label for="NuevaEntrada_NuevaAccion" class="form-label">Acción:</label>
                        <input asp-for="NuevaEntrada.NuevaAccion"
                               class="form-control"
                               required
                               maxlength="50" />
                    </div>
                    <div class="col-md-5 mb-3">
                        <label for="NuevaEntrada_NuevaDescripcion" class="form-label">Descripción:</label>
                        <input asp-for="NuevaEntrada.NuevaDescripcion"
                               class="form-control"
                               required
                               maxlength="200" />
                    </div>
                    <div class="col-md-2 d-flex align-items-end mb-3">
                        <button type="button" id="btnAgregarLog" class="btn btn-success w-100">
                            <i class="fas fa-plus-circle me-1"></i> Agregar Entrada
                        </button>
						<button type="button" id="btnLimpiarLog" class="btn btn-danger w-100 ms-2">
							<i class="fas fa-eraser me-1"></i> Limpiar
						</button>
                    </div>
                </div>
            </form>

            <!-- Tabla de registros -->
            <div class="products-table table-responsive">
                <table id="logs-table" class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Fecha y Hora</th>
                            <th>Usuario</th>
                            <th>Acción</th>
                            <th>Descripción</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var log in Model.Logs)
                        {
                            <tr>
                                <td>@log.FechaHora</td>
                                <td>@log.Usuario</td>
                                <td>@log.Accion</td>
                                <td>@log.Descripcion</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script>

         document.getElementById('btnAgregarLog').addEventListener('click', function () {
            const form = document.getElementById('formAgregarLog');

            if (!form.checkValidity()) {
                const firstInvalid = form.querySelector(':invalid');
                const label = form.querySelector(`label[for="${firstInvalid.id}"]`)?.innerText || 'Campo';

                let msg;
                switch (firstInvalid.id) {
                    case 'NuevaEntrada_NuevaAccion':
                        msg = 'Debe ingresar una acción (máx. 50 caracteres).';
                        break;
                    case 'NuevaEntrada_NuevaDescripcion':
                        msg = 'Debe ingresar una descripción (máx. 200 caracteres).';
                        break;
                    default:
                        msg = firstInvalid.validationMessage;
                }

                Swal.fire({
                    icon: 'error',
                    title: 'Campo inválido',
                    text: `${label}: ${msg}`
                });

                return;
            }

            mostrarAlertaExitoAgregarLog();
        });

        document.getElementById('btnLimpiarLog').addEventListener('click', function () {
                    document.getElementById('formAgregarLog').reset();
		});
       
        function mostrarAlertaExitoAgregarLog() {
            Swal.fire({
                title: '¿Qué deseas hacer?',
                text: "Selecciona una opción para continuar.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Aceptar',
                cancelButtonText: 'Cancelar',
                customClass: {
                    confirmButton: 'btn-confirm',
                    denyButton: 'btn-deny',
                    cancelButton: 'btn-cancel'
                },
                buttonsStyling: false
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('formAgregarLog').submit();
                } else if (result.isDenied) {
                    document.getElementById('formAgregarLog').reset();
                }
            });
        }


        $(document).ready(function () {
            $('#logs-table').DataTable({
                responsive: true,
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json',
                    search: 'Buscar producto:', // Cambia el texto del campo de búsqueda
                    lengthMenu: 'Mostrar _MENU_ logs por página',
                    info: 'Mostrando _START_ a _END_ de _TOTAL_ logs',
                    paginate: {
                        first: 'Primero',
                        last: 'Último',
                        next: 'Siguiente',
                        previous: 'Anterior'
                    }
                },
                scrollX: true,
                fixedHeader: true,
                autoWidth: false,
                dom: '<"top"f>rt<"bottom"lp><"clear">', // Personaliza la disposición de los elementos
                pagingType: 'full_numbers', // Cambia el estilo de la paginación
                lengthMenu: [10, 25, 50, -1], // Opciones de cantidad de filas por página
                order: [[0, 'desc']], // Ordena por la segunda columna (Producto) de forma descendente
            });
        });

        var sesionActiva = sessionStorage.getItem('sesionActiva');

        if (!sesionActiva || sesionActiva !== 'true') {
            // Borrar sesión en el servidor
            window.location.href =  '@Url.Action("Login", "Login")';
        }

        var nombreSesion = '@(Context.Session.GetString("UsrNombre"))';

        if (!nombreSesion || nombreSesion === '' || nombreSesion === 'null' || nombreSesion === 'undefined') {
            window.location.href = '@Url.Action("Login", "Login")';
        }

    </script>

}