@model IEnumerable<ProyectoDojoGeko.Models.BitacoraViewModel>
@{
    ViewData["Title"] = "Bitácora del Sistema";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";

    var userRoles = new List<string>();
    if (User.IsInRole("SuperAdministrador")) userRoles.Add("SuperAdministrador");
    if (User.IsInRole("Administrador")) userRoles.Add("Administrador");
    if (User.IsInRole("Editor")) userRoles.Add("Editor");
    if (User.IsInRole("Visualizador")) userRoles.Add("Visualizador");

    bool puedeHacerTodo = userRoles.Any(r => r == "SuperAdministrador");
    bool puedeCrear = userRoles.Any(r => new[] { "SuperAdministrador", "Administrador", "Editor" }.Contains(r));
    bool puedeEditar = userRoles.Any(r => new[] { "SuperAdministrador", "Administrador", "Editor" }.Contains(r));
    bool puedeEliminar = userRoles.Any(r => new[] { "SuperAdministrador", "Administrador" }.Contains(r));

    bool mostrandoTodos = ViewBag.MostrandoTodos ?? false;
    int totalDisponibles = ViewBag.TotalRegistrosDisponibles ?? 0;
}

<link rel="stylesheet" href="~/css/bitacora.css" />
<!--<link rel="stylesheet" href="~/css/bitacora - Copia.css" />-->

<div class="bitacora-container">
     Header con título y breadcrumb -->
    <div class="bitacora-header">
        <div class="header-title">
            <h1>Bitácora del Sistema</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    @if (mostrandoTodos)
                    {
                        <li class="breadcrumb-item">
                            <span class="badge bg-info">Mostrando todos los registros (@totalDisponibles)</span>
                        </li>
                    }
                    else
                    {
                        <li class="breadcrumb-item">
                            <span class="badge bg-primary">Solo registros de hoy (@Model.Count() de @totalDisponibles)</span>
                        </li>
                    }
                </ol>
            </nav>
        </div>
        <div class="header-icon">
            <i class="fas fa-history"></i>
        </div>
    </div>

    <!-- Barra de acciones principales -->
    <div class="action-toolbar">
        <div class="action-group">
            @if (!mostrandoTodos)
            {
                <a href="@Url.Action("Index", new { mostrarTodos = true })" class="btn-action btn-info">
                    <i class="fas fa-eye"></i>
                    <span>Ver Todos los Registros</span>
                </a>
            }
            else
            {
                <a href="@Url.Action("Index")" class="btn-action btn-secondary">
                    <i class="fas fa-calendar-day"></i>
                    <span>Solo Hoy</span>
                </a>
            }

            @if (puedeHacerTodo)
            {
                <button id="btnAgregarRegistro" class="btn-action btn-add">
                    <i class="fas fa-plus"></i>
                    <span>Agregar Registro</span>
                </button>
            }
        </div>

        <div class="action-group">
            <button id="btnFiltros" class="btn-action btn-filter">
                <i class="fas fa-filter"></i>
                <span>Filtros</span>
            </button>
            <button id="btnExportarExcel" class="btn-action btn-excel">
                <i class="fas fa-file-excel"></i>
                <span>Exportar Excel</span>
            </button>
            <button id="btnExportarPDF" class="btn-action btn-pdf">
                <i class="fas fa-file-pdf"></i>
                <span>Exportar PDF</span>
            </button>
            <button id="btnRefrescar" class="btn-action btn-refresh">
                <i class="fas fa-sync-alt"></i>
                <span>Actualizar</span>
            </button>
        </div>
    </div>

    <!-- Panel de filtros (inicialmente oculto) -->
    <div id="filtrosPanel" class="filters-panel">
        <div class="filters-header">
            <h3><i class="fas fa-filter"></i> Filtros de Búsqueda</h3>
            <button id="btnCerrarFiltros" class="btn-close-filters">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="filters-body">
            <div class="filter-row">
                <div class="form-group">
                    <div class="filter-group">
                        <label for="filtroAccion">Acción</label>
                        <div class="select-wrapper">
                            <i class="fas fa-tag select-icon"></i>
                            <select id="filtroAccion" class="modern-select">
                                <option value="">Todas las acciones</option>
                                <option value="Login">Login</option>
                                <option value="Logout">Logout</option>
                                <option value="Crear Usuario">Crear Usuario</option>
                                <option value="Editar Usuario">Editar Usuario</option>
                                <option value="Eliminar Usuario">Eliminar Usuario</option>
                                <option value="Crear Empleado">Crear Empleado</option>
                                <option value="Editar Empleado">Editar Empleado</option>
                                <option value="Eliminar Empleado">Eliminar Empleado</option>
                                <option value="Cambio Contraseña">Cambio Contraseña</option>
                                <option value="Error Sistema">Error Sistema</option>
                                <option value="Consulta Bitácora">Consulta Bitácora</option>
                                <option value="Exportar Datos">Exportar Datos</option>
                                <option value="Configuración Sistema">Configuración Sistema</option>
                                <option value="Backup Base Datos">Backup Base Datos</option>
                                <option value="Mantenimiento Sistema">Mantenimiento Sistema</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="filtroUsuario">ID Usuario</label>
                    <div class="input-icon">
                        <i class="fas fa-user"></i>
                        <input type="number" id="filtroUsuario" placeholder="ID del usuario..." min="1">
                    </div>
                </div>
            </div>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filtroFechaDesde">Fecha Desde</label>
                    <div class="input-icon">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="filtroFechaDesde">
                    </div>
                </div>
                <div class="filter-group">
                    <label for="filtroFechaHasta">Fecha Hasta</label>
                    <div class="input-icon">
                        <i class="fas fa-calendar-alt"></i>
                        <input type="date" id="filtroFechaHasta">
                    </div>
                </div>
            </div>
            <div class="filter-actions">
                <button id="btnAplicarFiltros" class="btn-apply">
                    <i class="fas fa-check"></i> Aplicar Filtros
                </button>
                <button id="btnLimpiarFiltros" class="btn-clear">
                    <i class="fas fa-eraser"></i> Limpiar Filtros
                </button>
            </div>
        </div>
    </div>

    <!-- Resto del contenido igual... -->
    <!-- Formulario para agregar registro, alertas, contador y contenido de bitácora -->
    <!-- Contador de registros -->
    <div class="records-counter">
        <i class="fas fa-list"></i>
        <span id="totalRegistros">@(Model != null ? Model.Count() : 0) registros mostrados</span>
    </div>

    <!-- Contenedor principal de la bitácora -->
    <div class="bitacora-content">
        @if (Model != null && Model.Any())
        {
            var registrosPorFecha = Model.GroupBy(b => b.FechaEntrada.Date)
            .OrderByDescending(g => g.Key);
            foreach (var grupo in registrosPorFecha)
            {
                var fecha = grupo.Key;
                var diaSemana = fecha.ToString("dddd", new System.Globalization.CultureInfo("es-ES"));
                diaSemana = char.ToUpper(diaSemana[0]) + diaSemana.Substring(1);
                var registrosDia = grupo.OrderByDescending(b => b.FechaEntrada);
                var claseDia = ObtenerClaseDia(fecha.DayOfWeek);

                <div class="day-group @claseDia">
                    <div class="day-header">
                        <div class="day-info">
                            <div class="day-name">@diaSemana</div>
                            <div class="day-date">@fecha.ToString("dd/MM/yyyy")</div>
                        </div>
                        <div class="day-count">
                            <span>@registrosDia.Count() registros</span>
                        </div>
                    </div>
                    <div class="day-content">
                        <div class="timeline">
                            @foreach (var registro in registrosDia)
                            {
                                <div class="timeline-item">
                                    <div class="timeline-point"></div>
                                    <div class="timeline-content">
                                        <div class="timeline-header">
                                            <span class="timeline-time">@registro.FechaEntrada.ToString("HH:mm:ss")</span>
                                            <span class="timeline-action">@registro.Accion</span>
                                        </div>
                                        <div class="timeline-body">
                                            <p>@registro.Descripcion</p>
                                        </div>
                                        <div class="timeline-footer">
                                            <span class="timeline-user" data-id="@registro.FK_IdUsuario">
                                                <i class="fas fa-user"></i> Usuario: @registro.FK_IdUsuario
                                            </span>
                                            <span class="timeline-system" data-id="@registro.FK_IdSistema">
                                                <i class="fas fa-server"></i> Sistema: @registro.FK_IdSistema
                                            </span>
                                            <button class="btn-details" data-id="@registro.IdBitacora" title="Ver detalles">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="no-records">
                <div class="no-records-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <h3>No hay registros disponibles</h3>
                @if (mostrandoTodos)
                {
                    <p>No se encontraron registros de bitácora en el sistema.</p>
                }
                else
                {
                    <p>No hay registros para el día de hoy. <a href="@Url.Action("Index", new { mostrarTodos = true })">Ver todos los registros</a></p>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
    <script src="~/js/bitacora.js"></script>
}

@functions {
    public string ObtenerClaseDia(DayOfWeek dia)
    {
        switch (dia)
        {
            case DayOfWeek.Monday: return "day-monday";
            case DayOfWeek.Tuesday: return "day-tuesday";
            case DayOfWeek.Wednesday: return "day-wednesday";
            case DayOfWeek.Thursday: return "day-thursday";
            case DayOfWeek.Friday: return "day-friday";
            case DayOfWeek.Saturday: return "day-saturday";
            case DayOfWeek.Sunday: return "day-sunday";
            default: return "";
        }
    }
}