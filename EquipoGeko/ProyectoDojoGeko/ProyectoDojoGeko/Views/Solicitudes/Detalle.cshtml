@model ProyectoDojoGeko.Models.SolicitudViewModel
@{
    ViewData["Title"] = "Detalle de la Solicitud - GEKO Sistemas de Seguridad";
    Layout = "~/Views/Shared/_DashboardLayoutSistema.cshtml";
    var empleado = ViewBag.Empleado;
}

<link rel="stylesheet" href="~/css/empleado-detalle.css" />
<link rel="stylesheet" href="~/css/detalle-solicitud.css" />

<div class="empleado-detalle-container" id="contenido-pdf">
    <!-- Encabezado -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fas fa-id-card icon-naranja"></i>
                Detalle de Solicitud
            </h1>
            <p class="page-subtitle">Información detallada sobre la solicitud de vacaciones</p>
        </div>
    </div>

    <div class="empleado-card">
        <!-- Tarjeta de resumen -->
        <div class="info-box">
            <h2 class="empleado-nombre-s">@Model.Encabezado.NombreEmpleado</h2>
            <p class="empleado-id">Número de solicitud: <strong>@Model.Encabezado.IdSolicitud</strong></p>
            <div class="estado-box">
                <span class="badge estado-@Model.Encabezado.Estado">
                    <i class="fas fa-info-circle"></i> @Model.Encabezado.Estado
                </span>
            </div>
            <div class="detalle-mini-grid">
                <div class="stat-item">
                    <div class="stat-label">Días solicitados</div>
                    <div class="stat-value">@Model.Encabezado.DiasSolicitadosTotal días</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Fecha de creación</div>
                    <div class="stat-value">@Model.Encabezado.FechaIngresoSolicitud.ToString("dd/MM/yyyy")</div>
                </div>
            </div>
        </div>

        <!-- Información del Empleado -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-user icon-naranja"></i> Información del Empleado
                </h3>
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-id-card icon-naranja"></i> Código</div>
                    <div class="info-value">@empleado?.CodigoEmpleado</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-building icon-naranja"></i> Departamento</div>
                    <div class="info-value">@empleado?.Departamento</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-briefcase icon-naranja"></i> Puesto</div>
                    <div class="info-value">@empleado?.Puesto</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-calendar-plus icon-naranja"></i> Fecha de Ingreso</div>
                    <div class="info-value">@(empleado?.FechaIngreso?.ToString("dd/MM/yyyy") ?? "")</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-envelope icon-naranja"></i> Correo</div>
                    <div class="info-value">@empleado?.CorreoInstitucional</div>
                </div>
                <div class="info-item">
                    <div class="info-label"><i class="fas fa-phone icon-naranja"></i> Teléfono</div>
                    <div class="info-value">@empleado?.Telefono</div>
                </div>
            </div>
        </div>

        <!-- Tabla de fechas -->
        <div class="info-section">
            <div class="section-header">
                <h3 class="section-title">
                    <i class="fas fa-calendar-alt icon-naranja"></i> Fechas Solicitadas
                </h3>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-bordered text-center align-middle tabla-fechas-solicitadas">
                    <thead class="table-light">
                        <tr>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Días Hábiles</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in Model.Detalles)
                        {
                            <tr>
                                <td>@d.FechaInicio.ToString("dd/MM/yyyy")</td>
                                <td>@d.FechaFin.ToString("dd/MM/yyyy")</td>
                                <td>@d.DiasHabilesTomados</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Acciones -->
    <div class="acciones-box">
        <!-- Botón PDF -->
        <button type="button" onclick="generarPDF()" class="btn btn-primary boton-accion" id="btn-pdf">
            <i class="fas fa-file-pdf"></i> <span id="pdf-text">Generar PDF</span>
        </button>

        <form asp-action="Autorizar" method="post" class="inline-form">
            <input type="hidden" name="idSolicitud" value="@Model.Encabezado.IdSolicitud" />
            <button type="submit" class="btn btn-success boton-accion">
                <i class="fas fa-check"></i> Autorizar
            </button>
        </form>

        <form asp-action="Rechazar" method="post" class="inline-form">
            <input type="hidden" name="idSolicitud" value="@Model.Encabezado.IdSolicitud" />
            <button type="submit" class="btn btn-danger boton-accion">
                <i class="fas fa-times"></i> Rechazar
            </button>
        </form>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/empresas.css" />
    <link rel="stylesheet" href="~/css/detalle-solicitud.css" />
}

<style>
    .acciones-box {
        display: flex;
        justify-content: center;
        gap: 1.5rem;
        margin-top: 2rem;
        padding: 1.5rem;
        background-color: #f9f9f9;
        border-top: 1px solid #ddd;
        border-radius: 0 0 12px 12px;
    }

    .inline-form {
        display: inline-block;
    }

    .boton-accion {
        padding: 0.6rem 1.5rem;
        font-size: 1rem;
        border-radius: 8px;
        min-width: 140px;
        transition: all 0.3s ease;
    }

        .boton-accion i {
            margin-right: 8px;
        }

    .tabla-fechas-solicitadas td, .tabla-fechas-solicitadas th {
        padding: 1rem !important;
        font-size: 1rem;
    }

    /* Notificación de éxito */
    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 9999;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }

        .notification.success {
            background-color: #28a745;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }
</style>

<!-- Scripts para PDF - Usando pdfMake -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
    // Datos de la solicitud para JavaScript
    const solicitudData = {
        idSolicitud: @Model.Encabezado.IdSolicitud,
        nombreEmpleado: '@Html.Raw(Model.Encabezado.NombreEmpleado)',
        codigoEmpleado: '@Html.Raw(empleado?.CodigoEmpleado ?? "")',
        departamento: '@Html.Raw(empleado?.Departamento ?? "")',
        puesto: '@Html.Raw(empleado?.Puesto ?? "")',
        fechaIngreso: '@(empleado?.FechaIngreso?.ToString("dd/MM/yyyy") ?? "")',
        correo: '@Html.Raw(empleado?.CorreoInstitucional ?? "")',
        telefono: '@Html.Raw(empleado?.Telefono ?? "")',
        fechaSolicitud: '@Model.Encabezado.FechaIngresoSolicitud.ToString("dd/MM/yyyy")',
        diasSolicitados: @Model.Encabezado.DiasSolicitadosTotal,
        estado: '@Html.Raw(Model.Encabezado.Estado)',
        detalles: [
            @foreach (var detalle in Model.Detalles)
            {
                    <text>{
                        fechaInicio: '@detalle.FechaInicio.ToString("dd/MM/yyyy")',
                        fechaFin: '@detalle.FechaFin.ToString("dd/MM/yyyy")',
                        diasHabiles: @detalle.DiasHabilesTomados
                    },</text>
            }
        ]
    };

    function generarPDF() {
        console.log('Iniciando generación de PDF con pdfMake...');

        // Cambiar texto del botón
        const btnPdf = document.getElementById('btn-pdf');
        const pdfText = document.getElementById('pdf-text');
        const textoOriginal = pdfText.textContent;

        pdfText.textContent = 'Generando...';
        btnPdf.disabled = true;

        // Función para restaurar botón
        function restaurarBoton() {
            pdfText.textContent = textoOriginal;
            btnPdf.disabled = false;
        }

        // Verificar que pdfMake esté disponible
        if (typeof pdfMake === 'undefined') {
            alert('Error: No se pudo cargar la librería PDF. Verifique su conexión a internet.');
            restaurarBoton();
            return;
        }

        try {
            // Crear filas de la tabla de detalles
            const filasTabla = [
                // Cabecera de la tabla
                [
                    { text: 'Fecha Inicio', style: 'tableHeader' },
                    { text: 'Fecha Fin', style: 'tableHeader' },
                    { text: 'Días Hábiles', style: 'tableHeader' }
                ]
            ];

            // Agregar filas de datos
            solicitudData.detalles.forEach(detalle => {
                filasTabla.push([
                    { text: detalle.fechaInicio, style: 'tableCell' },
                    { text: detalle.fechaFin, style: 'tableCell' },
                    { text: detalle.diasHabiles.toString(), style: 'tableCell', alignment: 'center' }
                ]);
            });

            // Definición del documento PDF - VERSIÓN MEJORADA
            const docDefinition = {
                pageSize: 'A4',
                pageMargins: [40, 40, 40, 40],

                content: [
                    // Título principal - con colores más fuertes
                    {
                        text: 'Detalle de Solicitud',
                        style: 'mainTitle',
                        margin: [0, 0, 0, 8]
                    },

                    // Subtítulo - con color más fuerte
                    {
                        text: 'Información detallada sobre la solicitud de vacaciones',
                        style: 'subtitle',
                        margin: [0, 0, 0, 20]
                    },

                    // Número de solicitud - con color más fuerte
                    {
                        text: `Número de solicitud: ${solicitudData.idSolicitud}`,
                        style: 'solicitudNumber',
                        margin: [0, 0, 0, 25]
                    },

                    // Sección de días solicitados y fecha - mejorada
                    {
                        table: {
                            widths: ['50%', '50%'],
                            body: [
                                [
                                    {
                                        stack: [
                                            { text: 'Días solicitados', style: 'statLabel', alignment: 'center' },
                                            { text: `${solicitudData.diasSolicitados} días`, style: 'statValue', alignment: 'center' }
                                        ],
                                        border: [false, false, false, false]
                                    },
                                    {
                                        stack: [
                                            { text: 'Fecha de creación', style: 'statLabel', alignment: 'center' },
                                            { text: solicitudData.fechaSolicitud, style: 'statValue', alignment: 'center' }
                                        ],
                                        border: [false, false, false, false]
                                    }
                                ]
                            ]
                        },
                        layout: 'noBorders',
                        margin: [0, 0, 0, 30]
                    },

                    // Título "Información del Empleado" - mejorado
                    {
                        text: 'Información del Empleado',
                        style: 'sectionTitle',
                        margin: [0, 0, 0, 20]
                    },

                    // Grid de información del empleado - mejorado
                    {
                        table: {
                            widths: ['33%', '33%', '34%'],
                            body: [
                                [
                                    {
                                        stack: [
                                            { text: 'Código', style: 'fieldLabel' },
                                            { text: solicitudData.codigoEmpleado, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 15]
                                    },
                                    {
                                        stack: [
                                            { text: 'Departamento', style: 'fieldLabel' },
                                            { text: solicitudData.departamento, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 15]
                                    },
                                    {
                                        stack: [
                                            { text: 'Puesto', style: 'fieldLabel' },
                                            { text: solicitudData.puesto, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 0, 15]
                                    }
                                ],
                                [
                                    {
                                        stack: [
                                            { text: 'Fecha de Ingreso', style: 'fieldLabel' },
                                            { text: solicitudData.fechaIngreso, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 0]
                                    },
                                    {
                                        stack: [
                                            { text: 'Correo', style: 'fieldLabel' },
                                            { text: solicitudData.correo, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 10, 0]
                                    },
                                    {
                                        stack: [
                                            { text: 'Teléfono', style: 'fieldLabel' },
                                            { text: solicitudData.telefono, style: 'fieldValue' }
                                        ],
                                        border: [false, false, false, false],
                                        margin: [0, 0, 0, 0]
                                    }
                                ]
                            ]
                        },
                        layout: 'noBorders',
                        margin: [0, 0, 0, 30]
                    },

                    // Título "Fechas Solicitadas" - mejorado
                    {
                        text: 'Fechas Solicitadas',
                        style: 'sectionTitle',
                        margin: [0, 0, 0, 20]
                    },

                    // Tabla de fechas - mejorada
                    {
                        table: {
                            headerRows: 1,
                            widths: ['*', '*', '*'],
                            body: filasTabla
                        },
                        layout: {
                            hLineWidth: function (i, node) {
                                return (i === 0 || i === node.table.body.length) ? 2 : 1;
                            },
                            vLineWidth: function (i, node) {
                                return (i === 0 || i === node.table.widths.length) ? 2 : 1;
                            },
                            hLineColor: function (i, node) {
                                return (i === 0 || i === node.table.body.length) ? '#2c3e50' : '#bdc3c7';
                            },
                            vLineColor: function (i, node) {
                                return (i === 0 || i === node.table.widths.length) ? '#2c3e50' : '#bdc3c7';
                            },
                            fillColor: function (rowIndex, node, columnIndex) {
                                return (rowIndex === 0) ? '#ecf0f1' : (rowIndex % 2 === 0 ? '#f8f9fa' : null);
                            },
                            paddingLeft: function(i, node) { return 8; },
                            paddingRight: function(i, node) { return 8; },
                            paddingTop: function(i, node) { return 8; },
                            paddingBottom: function(i, node) { return 8; }
                        },
                        margin: [0, 0, 0, 20]
                    }
                ],

                styles: {
                    mainTitle: {
                        fontSize: 22,
                        bold: true,
                        color: '#2c3e50'  // Azul oscuro fuerte
                    },
                    subtitle: {
                        fontSize: 13,
                        color: '#34495e',  // Gris azulado fuerte
                        italics: true
                    },
                    solicitudNumber: {
                        fontSize: 12,
                        color: '#2c3e50',  // Azul oscuro fuerte
                        bold: true
                    },
                    statLabel: {
                        fontSize: 11,
                        color: '#7f8c8d',  // Gris fuerte
                        margin: [0, 0, 0, 5]
                    },
                    statValue: {
                        fontSize: 16,
                        bold: true,
                        color: '#e74c3c'  // Rojo fuerte para destacar
                    },
                    sectionTitle: {
                        fontSize: 16,
                        bold: true,
                        color: '#2980b9',  // Azul fuerte
                        decoration: 'underline'
                    },
                    fieldLabel: {
                        fontSize: 11,
                        color: '#3498db',  // Azul brillante fuerte
                        bold: true,
                        margin: [0, 0, 0, 3]
                    },
                    fieldValue: {
                        fontSize: 11,
                        color: '#2c3e50'  // Azul oscuro fuerte
                    },
                    tableHeader: {
                        fontSize: 12,
                        bold: true,
                        color: '#2c3e50',  // Azul oscuro fuerte
                        alignment: 'center'
                    },
                    tableCell: {
                        fontSize: 11,
                        color: '#34495e',  // Gris azulado fuerte
                        alignment: 'center'
                    }
                }
            };

            // Generar y descargar el PDF
            pdfMake.createPdf(docDefinition).download(`Solicitud_Vacaciones_${solicitudData.idSolicitud}_${new Date().toISOString().slice(0, 10)}.pdf`);

            // Mostrar notificación de éxito
            mostrarNotificacion("Archivo PDF exportado exitosamente", "success");

            // Restaurar botón
            restaurarBoton();

        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
            restaurarBoton();
        }
    }

    // Función para mostrar notificaciones
    function mostrarNotificacion(mensaje, tipo) {
        // Crear elemento de notificación
        const notification = document.createElement('div');
        notification.className = `notification ${tipo}`;
        notification.textContent = mensaje;

        // Agregar al DOM
        document.body.appendChild(notification);

        // Mostrar con animación
        setTimeout(() => {
            notification.classList.add('show');
        }, 100);

        // Ocultar después de 3 segundos
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 3000);
    }

    // Verificar carga de librerías al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Verificando pdfMake...');

        if (typeof pdfMake !== 'undefined') {
            console.log('✅ pdfMake cargado correctamente');
        } else {
            console.error('❌ pdfMake NO está disponible');
        }
    });
</script>
