@model ProyectoDojoGeko.Models.GestionFeriadosViewModel

@{
    ViewData["Title"] = "Gestión de Feriados Fijos";
    Layout = "~/Views/Shared/_DashboardLayoutSistema.cshtml";
}


<div class="empresas-container">

    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fa-solid fa-calendar-days"></i>
                Feriados Fijos
            </h1>
            <p class="page-subtitle">
                Listado de todos los feriados fijos anuales añadidos al sistema.
            </p>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-agregarf" onclick="abrirModalFeriadoFijo()">
                <i class="fas fa-plus me-1"></i> Nuevo feriado
            </button>
        </div>
    </div>



<!-- Tabla de Feriados Fijos -->
    <div class="table-container">
        <table class="empresas-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Descripción</th>
                            <th>Tipo</th>
                            <th>Proporción</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.FeriadosFijos != null && Model.FeriadosFijos.Any())
                        {
                            @foreach (var item in Model.FeriadosFijos)
                            {
                                <tr>
                                    <td>
                                        <span class="badge bg-info">@item.Dia/@item.Mes</span>
                                    </td>
                                    <td>@item.Descripcion</td>
                                    <td>@item.TipoFeriadoNombre</td>
                                    <td>
                                        <span class="badge @(item.ProporcionDia == 1.0m ? "bg-success" : "bg-warning")">
                                            @(item.ProporcionDia == 1.0m ? "Día Completo" : "Medio Día")
                                        </span>
                                    </td>
                            <td class="actions-cell">
                                <div class="actions-container">

                                    <button class="btn-action edit" onclick="editarFeriadoFijo(@item.Dia, @item.Mes, @item.TipoFeriadoId, '@item.Descripcion.Replace("'", "\'")', @item.ProporcionDia.ToString().Replace(',', '.'))"  title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button type="button" class="btn-action delete"
                                            onclick="confirmarEliminarFijo(@item.Dia, @item.Mes, @item.TipoFeriadoId)">
                                        <i class="fas fa-trash"></i>
                                    </button>

                                </div>
                            </td>
                            </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-calendar-times fa-2x mb-2"></i>
                                    <br>No hay feriados fijos registrados
                                    <br><small>Haga clic en "Agregar Nuevo" para comenzar</small>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>


<!--Modal agregar y editar-->
<div class="modal fade" id="modalFeriadoFijo" tabindex="-1" aria-labelledby="modalFeriadoFijoLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-elegante-content">
            <div class="modal-header modal-elegante-header">
                <h5 class="modal-title" id="modalFeriadoFijoLabel">
                    <i class="fas fa-calendar-plus me-2"></i> Nuevo Feriado Fijo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <form id="formFeriadoFijo" asp-action="GuardarFeriadoFijo" asp-controller="Feriados" method="post">
                <div class="modal-body modal-elegante-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="Original_Dia" name="Original_Dia" />
                    <input type="hidden" id="Original_Mes" name="Original_Mes" />
                    <input type="hidden" id="Original_TipoFeriadoId" name="Original_TipoFeriadoId" />

                    <p class="text-muted mb-4">
                        Completa la siguiente información del feriado fijo.
                    </p>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="Dia" class="form-label">Día: </label>
                            <input type="number" class="form-control form-control-elegante" id="Dia" name="Dia" min="1" max="31" required />
                            <div class="invalid-feedback" id="Dia-error"></div>
                        </div>
                        <br />
                        <div class="col-md-6">
                            <label for="Mes" class="form-label">Mes: </label>
                            <select class="form-select form-control-elegante" id="Mes" name="Mes" required>
                                <option value="" disabled selected>Selecciona...</option>
                                @for (int i = 1; i <= 12; i++)
                                {
                                    <option value="@i">@System.Globalization.CultureInfo.CurrentCulture.DateTimeFormat.GetMonthName(i)</option>
                                }
                            </select>
                            <div class="invalid-feedback" id="Mes-error"></div>
                        </div>
                        <br />
                        <div class="col-12">
                            <label for="Descripcion" class="form-label">Descripción: </label>
                            <input type="text" class="form-control form-control-elegante" id="Descripcion" name="Descripcion" maxlength="100" placeholder="Ej: Día de la Independencia" required />
                            <div class="invalid-feedback" id="Descripcion-error"></div>
                        </div>
                        <br />
                        <div class="col-md-8">
                            <label for="TipoFeriadoId" class="form-label">Tipo de Feriado: </label>
                            <select class="form-select form-control-elegante" id="TipoFeriadoId" name="TipoFeriadoId" required>
                                <option value="" disabled selected>Selecciona un tipo</option>
                                @if (Model.TiposFeriado != null)
                                {
                                    @foreach (var tipo in Model.TiposFeriado)
                                    {
                                        <option value="@tipo.TipoFeriadoId">@tipo.Nombre</option>
                                    }
                                }
                            </select>
                            <div class="invalid-feedback" id="TipoFeriadoId-error"></div>
                        </div>
                        <br />
                        <div class="col-md-4">
                            <label for="ProporcionDia" class="form-label">Proporción: </label>
                            <select class="form-select form-control-elegante" id="ProporcionDia" name="ProporcionDia">
                                <option value="1.0" selected>Día Completo</option>
                                <option value="0.5">Medio Día</option>
                            </select>
                            <div class="invalid-feedback" id="ProporcionDia-error"></div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer modal-elegante-footer">
                    <button type="button" class="btn btn-elegante-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="submit" class="btn btn-elegante-primary" id="btnGuardarFijo">
                        <i class="fas fa-save me-2"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalConfirmarEliminarLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Está seguro de que desea eliminar este feriado?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarEliminar">Sí, eliminar</button>
            </div>
        </div>
    </div>
</div>





<!--Estilos de la vista-->
@section Styles {
   <link rel="stylesheet" href="~/css/empresas.css" />
   <link rel="stylesheet" href="~/css/feriados.css" />
}

<style>
  .page-title i {
   color: #4B94C4;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <script>
        let modalFeriadoFijo;
        let modalConfirmar;
        let diaEliminar = null, mesEliminar = null, tipoFeriadoIdEliminar = null;

        document.addEventListener("DOMContentLoaded", function () {
            // Inicializar modales Bootstrap
            const modalFeriadoElement = document.getElementById('modalFeriadoFijo');
            const modalEliminarElement = document.getElementById('modalConfirmarEliminar');

            if (modalFeriadoElement) {
                modalFeriadoFijo = new bootstrap.Modal(modalFeriadoElement);
                modalFeriadoElement.addEventListener('hidden.bs.modal', limpiarFormularioFijo);
            }

            if (modalEliminarElement) {
                modalConfirmar = new bootstrap.Modal(modalEliminarElement);
            }

            // Validación de formulario
            const form = document.getElementById('formFeriadoFijo');
            if (form) {
                form.addEventListener('submit', function (event) {
                    const descripcion = document.getElementById('Descripcion');
                    const tipoFeriado = document.getElementById('TipoFeriadoId');
                    const dia = document.getElementById('Dia');
                    const mes = document.getElementById('Mes');

                    if (!descripcion.value.trim()) {
                        alert('Por favor, ingrese la descripción del feriado.');
                        descripcion.focus();
                        event.preventDefault();
                        return;
                    }

                    if (!tipoFeriado.value) {
                        alert('Por favor, seleccione un tipo de feriado.');
                        tipoFeriado.focus();
                        event.preventDefault();
                        return;
                    }

                    if (!dia.value || dia.value < 1 || dia.value > 31) {
                        alert('Por favor, ingrese un día válido (1-31).');
                        dia.focus();
                        event.preventDefault();
                        return;
                    }

                    if (!mes.value) {
                        alert('Por favor, seleccione un mes.');
                        mes.focus();
                        event.preventDefault();
                        return;
                    }
                });
            }

            // Botón de confirmación de eliminación
            const btnConfirmarEliminar = document.getElementById('confirmarEliminar');
            if (btnConfirmarEliminar) {
                btnConfirmarEliminar.addEventListener('click', eliminarFeriadoFijo);
            }
        });

        // Función para abrir modal de agregar
        function abrirModalFeriadoFijo() {
            limpiarFormularioFijo();
            document.getElementById("modalFeriadoFijoLabel").innerHTML = '<i class="fas fa-calendar-check me-2"></i> Agregar Feriado Fijo';

            if (modalFeriadoFijo) modalFeriadoFijo.show();
        }

        // Función para editar
        function editarFeriadoFijo(dia, mes, tipoFeriadoId, descripcion, proporcion) {
            limpiarFormularioFijo();

            document.getElementById("modalFeriadoFijoLabel").innerHTML = '<i class="fas fa-edit me-2"></i> Editar Feriado Fijo';

            document.getElementById("Dia").value = dia;
            document.getElementById("Mes").value = mes;
            document.getElementById("TipoFeriadoId").value = tipoFeriadoId;
            document.getElementById("Descripcion").value = descripcion;
            document.getElementById("ProporcionDia").value = proporcion || '1.0';

            document.getElementById("Original_Dia").value = dia;
            document.getElementById("Original_Mes").value = mes;
            document.getElementById("Original_TipoFeriadoId").value = tipoFeriadoId;

            if (modalFeriadoFijo) modalFeriadoFijo.show();
        }

        // Limpiar formulario
        function limpiarFormularioFijo() {
            const form = document.getElementById('formFeriadoFijo');
            if (form) form.reset();

            const idFeriado = document.getElementById('Id');
            if (idFeriado) idFeriado.value = 0;
        }

        // Confirmar antes de eliminar
        function confirmarEliminarFijo(dia, mes, tipoFeriadoId) {
            diaEliminar = dia;
            mesEliminar = mes;
            tipoFeriadoIdEliminar = tipoFeriadoId;
            if (modalConfirmar) modalConfirmar.show();
        }

        // Ejecutar eliminación
        function eliminarFeriadoFijo() {
            const tokenInput = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : "";

            fetch('@Url.Action("EliminarFeriadoFijo", "Feriados")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    dia: diaEliminar,
                    mes: mesEliminar,
                    tipoFeriadoId: tipoFeriadoIdEliminar,
                    __RequestVerificationToken: token
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarNotificacion(data.message, 'success');
                    modalConfirmar.hide();
                    setTimeout(() => location.reload(), 1500);
                } else {
                    mostrarNotificacion(data.message || 'Error al eliminar', 'error');
                }
            })
            .catch(() => {
                mostrarNotificacion('Error de red al eliminar feriado', 'error');
            });
        }

        function mostrarNotificacion(mensaje, tipo) {
            alert((tipo === 'success' ? '✅ ' : '❌ ') + mensaje);
        }
    </script>
}




