@model ProyectoDojoGeko.Models.GestionFeriadosViewModel

@{
    ViewData["Title"] = "Gestión de Feriados Variables";
    Layout = "~/Views/Shared/_DashboardLayoutSistema.cshtml";
}

<div class="empresas-container">

    <!-- Header -->
    <div class="page-header">
        <div class="header-content">
            <h1 class="page-title">
                <i class="fa-solid fa-calendar-day"></i>
                Feriados Variables
            </h1>
            <p class="page-subtitle">
                Listado de todos los feriados que cambian de fecha cada año añadidos al sistema.
            </p>
        </div>
        <div class="header-actions">
            <button type="button" class="btn btn-regresarv" onclick="abrirModalFeriadoVariable()">
                <i class="fas fa-plus me-1"></i> Nuevo feriado 
            </button>
        </div>
    </div>

    <!-- Tabla de Feriados Variables -->
    <div class="table-container">
        <table class="empresas-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Descripción</th>
                    <th>Tipo</th>
                    <th>Proporción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.FeriadosVariables != null && Model.FeriadosVariables.Any())
                {
                    @foreach (var item in Model.FeriadosVariables)
                    {
                        <tr>
                            <td>
                                <span class="badge bg-primary">@item.Fecha.ToString("dd/MM/yyyy")</span>
                            </td>
                            <td>@item.Descripcion</td>
                            <td>@item.TipoFeriadoNombre</td>
                            <td>
                                <span class="badge @(item.ProporcionDia == 1.0m ? "bg-success" : "bg-warning")">
                                    @(item.ProporcionDia == 1.0m ? "Día Completo" : "Medio Día")
                                </span>
                            </td>
                            <td class="actions-cell">
                                <div class="actions-container">

                                    <button type="button" class="btn-action edit" onclick="editarFeriadoVariable(@item.Id, '@item.Fecha.ToString("yyyy-MM-dd")', '@item.Descripcion.Replace("'", "\'")', @item.TipoFeriadoId, '@item.ProporcionDia.ToString().Replace(',', '.')')" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>

                                    <button type="button" class="btn-action delete" onclick="confirmarEliminarVariable(@item.Id)" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>

                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-4">
                            <i class="fas fa-calendar-times fa-2x mb-2"></i>
                            <br>No hay feriados variables registrados
                            <br><small>Haga clic en "Agregar Nuevo" para comenzar</small>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalFeriadoVariable" tabindex="-1" aria-labelledby="modalFeriadoVariableLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-elegantev-content">
            <div class="modal-header modal-elegantev-header">
                <h5 class="modal-title" id="modalFeriadoVariableLabel">
                    <i class="fas fa-calendar-plus me-2"></i> Nuevo Feriado Variable
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <form id="formFeriadoVariable" asp-action="GuardarFeriadoVariable" asp-controller="Feriados" method="post">
                <div class="modal-body modal-elegantev-body">
                    @Html.AntiForgeryToken()

                    <input type="hidden" id="Id" name="Id" value="0" />

                    <p class="text-muted mb-4">
                        Completa la siguiente información del feriado variable.
                    </p>

                    <div class="row g-4">
                        <div class="col-md-6">
                            <label for="Fecha" class="form-label">Fecha: </label>
                            <input type="date" class="form-control form-control-elegante" id="Fecha" name="Fecha" required/>
                            <div class="invalid-feedback" id="Fecha-error"></div>
                        </div>
                        <br />
                        <div class="col-12">
                            <label for="Descripcion" class="form-label">Descripción: </label>
                            <input type="text" class="form-control form-control-elegante" id="Descripcion" name="Descripcion" maxlength="100" placeholder="Ej: Viernes Santo" required />
                            <div class="invalid-feedback" id="Descripcion-error"></div>
                        </div>
                        <br />
                        <div class="col-md-8">
                            <label for="TipoFeriadoId" class="form-label">Tipo de Feriado: </label>
                            <select class="form-select form-control-elegante" id="TipoFeriadoId" name="TipoFeriadoId" required>
                                <option value="" disabled selected>Selecciona un tipo</option>
                                @if (Model.TiposFeriado != null)
                                {
                                    @foreach (var tipo in Model.TiposFeriado)
                                    {
                                        <option value="@tipo.TipoFeriadoId">@tipo.Nombre</option>
                                    }
                                }
                            </select>
                            <div class="invalid-feedback" id="TipoFeriadoId-error"></div>
                        </div>
                        <br />
                        <div class="col-md-4">
                            <label for="ProporcionDia" class="form-label">Proporción: </label>
                            <select class="form-select form-control-elegante" id="ProporcionDia" name="ProporcionDia">
                                <option value="1.0" selected>Día Completo</option>
                                <option value="0.5">Medio Día</option>
                            </select>
                            <div class="invalid-feedback" id="ProporcionDia-error"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer modal-elegante-footer">
                     <button type="button" class="btn btn-elegantev-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                     </button>
                     <button type="submit" class="btn btn-elegantev-primary" id="btnGuardarVariable">
                        <i class="fas fa-save me-2"></i>Guardar
                     </button>
                </div>
            </form>
         </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="modalConfirmarEliminar" tabindex="-1" aria-labelledby="modalConfirmarEliminarLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="modalConfirmarEliminarLabel"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Eliminación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                ¿Está seguro de que desea eliminar este feriado?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmarEliminar">Sí, eliminar</button>
            </div>
        </div>
    </div>
</div>


@section Styles {
    <link rel="stylesheet" href="~/css/empresas.css" />
    <link rel="stylesheet" href="~/css/feriados.css" />

    }

    <style>
    .empresas-table th {
        background: #42AD98;
        font-weight: 600;
        color: black;
        font-size: 14px;
        white-space: nowrap;
    }

    .page-title i {
        color: #48BDA3;
    }
    </style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
@section Scripts {
    <script>
        let modalFeriadoVariable;
        let modalConfirmar;
        let idFeriadoAEliminar = null;

        document.addEventListener("DOMContentLoaded", function () {
            const modalFeriadoElement = document.getElementById('modalFeriadoVariable');
            const modalEliminarElement = document.getElementById('modalConfirmarEliminar');

            if (modalFeriadoElement) {
                modalFeriadoVariable = new bootstrap.Modal(modalFeriadoElement);
            }

            if (modalEliminarElement) {
                modalConfirmar = new bootstrap.Modal(modalEliminarElement);
            }

            if (modalFeriadoElement) {
                modalFeriadoElement.addEventListener('hidden.bs.modal', function () {
                    limpiarFormularioVariable();
                });
            }

            // Asigna evento al botón "Sí, eliminar"
            document.getElementById('confirmarEliminar').addEventListener('click', function () {
                if (idFeriadoAEliminar !== null) {
                    eliminarFeriadoVariable(idFeriadoAEliminar);
                }
            });

            const form = document.getElementById('formFeriadoVariable');
            if (form) {
                form.addEventListener('submit', function (event) {
                    const descripcion = document.getElementById('Descripcion');
                    const tipoFeriado = document.getElementById('TipoFeriadoId');
                    const fecha = document.getElementById('Fecha');

                    if (!descripcion.value.trim()) {
                        alert('Por favor, ingrese la descripción del feriado.');
                        descripcion.focus();
                        event.preventDefault();
                        return;
                    }

                    if (!tipoFeriado.value) {
                        alert('Por favor, seleccione un tipo de feriado.');
                        tipoFeriado.focus();
                        event.preventDefault();
                        return;
                    }

                    if (!fecha.value) {
                        alert('Por favor, ingrese la fecha del feriado.');
                        fecha.focus();
                        event.preventDefault();
                    }
                });
            }
        });

        function abrirModalFeriadoVariable() {
            limpiarFormularioVariable();
            document.getElementById("modalFeriadoVariableLabel").innerHTML = '<i class="fas fa-calendar-check me-2"></i> Agregar Feriado Variable';

            if (modalFeriadoVariable) {
                modalFeriadoVariable.show();
            }
        }

        function editarFeriadoVariable(id, Fecha, Descripcion, TipoFeriadoId, ProporcionDia) {
            limpiarFormularioVariable();
            document.getElementById("modalFeriadoVariableLabel").innerHTML = '<i class="fas fa-edit me-2"></i>Editar Feriado Variable';

            document.getElementById("Id").value = id;
            document.getElementById("Fecha").value = Fecha;
            document.getElementById("Descripcion").value = Descripcion;
            document.getElementById("TipoFeriadoId").value = TipoFeriadoId;
            document.getElementById("ProporcionDia").value = ProporcionDia || '1.0';

            if (modalFeriadoVariable) {
                modalFeriadoVariable.show();
            }
        }

        function limpiarFormularioVariable() {
            const form = document.getElementById('formFeriadoVariable');
            if (form) {
                form.reset();
            }
            document.getElementById("Id").value = "0";

        }

        function confirmarEliminarVariable(id) {
            idFeriadoAEliminar = id;
            if (modalConfirmar) {
                modalConfirmar.show();
            }
        }

        function eliminarFeriadoVariable(id) {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            $.ajax({
                type: 'POST',
                url: '@Url.Action("EliminarFeriadoVariable", "Feriados")',
                data: {
                    id: id,
                    __RequestVerificationToken: token
                },
                success: function (response) {
                    if (response.success) {
                        mostrarNotificacion(response.message, 'success');
                        modalConfirmar.hide();
                        setTimeout(function () {
                            location.reload();
                        }, 1500);
                    } else {
                        mostrarNotificacion(response.message || 'Error al eliminar', 'error');
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error en la solicitud AJAX:", status, error);
                    mostrarNotificacion('Error de conexión con el servidor', 'error');
                }
            });
        }

        function mostrarNotificacion(mensaje, tipo) {
            alert((tipo === 'success' ? '✅ ' : '❌ ') + mensaje);
        }
    </script>
}

