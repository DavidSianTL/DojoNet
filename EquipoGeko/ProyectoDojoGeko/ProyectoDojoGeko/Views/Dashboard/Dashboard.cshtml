@model ProyectoDojoGeko.Models.DashboardViewModel

@{
    ViewData["Title"] = "Dashboard - GEKO Sistemas de Seguridad";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";

    // Usar las variables de ViewBag configuradas en el controlador
    var userRoles = ViewBag.UserRoles as List<string> ?? new List<string>();
    bool puedeHacerTodo = ViewBag.PuedeHacerTodo ?? false;
    bool puedeCrear = ViewBag.PuedeCrear ?? false;
    bool puedeEditar = ViewBag.PuedeEditar ?? false;
    bool puedeEliminar = ViewBag.PuedeEliminar ?? false;
    bool soloLectura = ViewBag.SoloLectura ?? false;
}

<div class="dashboard-container">
    <!-- Header del Dashboard -->
    <div class="dashboard-header" style="position: relative;">
        <div class="welcome-section">
            <h1 class="welcome-title">
                <i class="fas fa-tachometer-alt"></i>
                Bienvenido, @ViewBag.Usuario
            </h1>
            <p class="welcome-subtitle">
                Resumen general del sistema de seguridad institucional
            </p>
        </div>
        <div class="header-actions">
            <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Buscar usuarios, empresas..." class="search-input">
            </div>
        </div>
    </div>

    <!-- Tarjetas de Estad√≠sticas -->
    <div class="stats-grid">
        <div class="stat-card empresas">
            <div class="stat-icon">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.EmpresasActivas</div>
                <div class="stat-label">Empresas Activas</div>
                <div class="stat-change @(Model.CambioEmpresasMes > 0 ? "positive" : Model.CambioEmpresasMes < 0 ? "negative" : "neutral")">
                    <i class="fas fa-arrow-@(Model.CambioEmpresasMes > 0 ? "up" : Model.CambioEmpresasMes < 0 ? "down" : "minus")"></i>
                    @if (Model.CambioEmpresasMes > 0)
                    {
                        <span>+@Model.CambioEmpresasMes este mes</span>
                    }
                    else if (Model.CambioEmpresasMes < 0)
                    {
                        <span>@Model.CambioEmpresasMes este mes</span>
                    }
                    else
                    {
                        <span>Sin cambios</span>
                    }
                </div>
            </div>
        </div>

        <div class="stat-card usuarios">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.UsuariosTotales</div>
                <div class="stat-label">Usuarios Totales</div>
                <div class="stat-change @(Model.CambioUsuariosSemana > 0 ? "positive" : Model.CambioUsuariosSemana < 0 ? "negative" : "neutral")">
                    <i class="fas fa-arrow-@(Model.CambioUsuariosSemana > 0 ? "up" : Model.CambioUsuariosSemana < 0 ? "down" : "minus")"></i>
                    @if (Model.CambioUsuariosSemana > 0)
                    {
                        <span>+@Model.CambioUsuariosSemana esta semana</span>
                    }
                    else if (Model.CambioUsuariosSemana < 0)
                    {
                        <span>@Model.CambioUsuariosSemana esta semana</span>
                    }
                    else
                    {
                        <span>Sin cambios</span>
                    }
                </div>
            </div>
        </div>

        <div class="stat-card sistemas">
            <div class="stat-icon">
                <i class="fas fa-server"></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.SistemasRegistrados</div>
                <div class="stat-label">Sistemas Registrados</div>
                <div class="stat-change neutral">
                    <i class="fas fa-minus"></i>
                    Sin cambios
                </div>
            </div>
        </div>

        @* TARJETA DE ALERTAS - Solo muestra 1 cuando hay alertas de m√°s de 14 d√≠as disponibles *@
        @if (Model.TotalAlertasEmpleadosVacaciones > 0)
        {
            <div class="alert-container" style="position: relative;">
                <div id="tarjetaRevision" class="stat-card alertas" style="cursor: pointer;">
                    <div class="stat-icon">
                        <i class="fas fa-bell" style="color: #dc3545;"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-number">1</div>
                        <div class="stat-label" style="color: #212529;">
                            Notificaci√≥n: Empleados requieren revisi√≥n
                            <i id="chevronIcon" class="fas fa-chevron-down" style="float: right; transition: transform 0.3s;"></i>
                        </div>
                        <div class="stat-change warning">
                            <i class="fas fa-exclamation-circle"></i>
                            Requieren atenci√≥n
                        </div>
                    </div>
                </div>

                <div id="panelRevision" class="notification-panel">
                    <h4 style="font-size: 1rem; margin-bottom: 8px; color: #333;">Detalles de revisi√≥n</h4>

                    @if (Model.AlertasEmpleadosVacaciones != null && Model.AlertasEmpleadosVacaciones.Any())
                    {
                        <ul style="padding-left: 18px; margin: 0; color: #555;">
                            @foreach (var alerta in Model.AlertasEmpleadosVacaciones)
                            {
                                <li style="margin-bottom: 8px; border-bottom: 1px solid #eee; padding-bottom: 6px;">
                                    <div style="font-weight: bold; color: #dc3545;">
                                        <strong>C√≥digo:</strong> @alerta.Codigo |
                                        <strong>Nombre:</strong> @alerta.NombreCompleto
                                    </div>
                                    @if (alerta.TipoNotificacion.Contains("m√°s de 14 d√≠as"))
                                    {
                                        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                            üìÖ <strong>A√±os trabajados:</strong> @alerta.AniosTrabajados.ToString("F1")<br>
                                            üìä <strong>D√≠as acumulados:</strong> @alerta.DiasAcumuladosTotal.ToString("F1")<br>
                                            ‚úÖ <strong>D√≠as tomados:</strong> @alerta.DiasYaTomados.ToString("F1")<br>
                                            üîî <strong>D√≠as disponibles:</strong> @alerta.DiasDisponibles.ToString("F1")
                                        </div>
                                    }
                                    else
                                    {
                                        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 2px;">
                                            ‚ö†Ô∏è Empleado pr√≥ximo a salir con vacaciones tomadas
                                        </div>
                                    }
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        }
        else
        {
            @* TARJETA CUANDO NO HAY ALERTAS *@
            <div class="stat-card sistemas">
                <div class="stat-icon">
                    <i class="fas fa-check-circle" style="color: #28a745;"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-number">0</div>
                    <div class="stat-label">Sin alertas</div>
                    <div class="stat-change positive">
                        <i class="fas fa-check"></i>
                        Todo en orden
                    </div>
                </div>
            </div>
        }
    </div>

    <style>
        .notification-panel {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 12px;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease-out;
            max-height: 400px;
            overflow-y: auto;
        }

            .notification-panel.show {
                display: block;
                opacity: 1;
                transform: translateY(0);
            }

        .alert-container {
            position: relative;
        }

        .stat-card.alertas:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        /* Scrollbar personalizado para el panel */
        .notification-panel::-webkit-scrollbar {
            width: 6px;
        }

        .notification-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .notification-panel::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }

            .notification-panel::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }
    </style>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#tarjetaRevision').click(function (e) {
                e.stopPropagation();
                var panel = $('#panelRevision');
                var chevron = $('#chevronIcon');

                if (panel.hasClass('show')) {
                    panel.removeClass('show');
                    chevron.css('transform', 'rotate(0deg)');
                    setTimeout(function() {
                        panel.hide();
                    }, 300);
                } else {
                    panel.show();
                    setTimeout(function() {
                        panel.addClass('show');
                    }, 10);
                    chevron.css('transform', 'rotate(180deg)');
                }
            });

            // Cerrar el panel si se hace clic fuera de √©l
            $(document).click(function(event) {
                if (!$(event.target).closest('.alert-container').length) {
                    var panel = $('#panelRevision');
                    var chevron = $('#chevronIcon');
                    if (panel.hasClass('show')) {
                        panel.removeClass('show');
                        chevron.css('transform', 'rotate(0deg)');
                        setTimeout(function() {
                            panel.hide();
                        }, 300);
                    }
                }
            });
        });
    </script>

    <!-- Contenido Principal -->
    <div class="dashboard-content">
        <!-- Actividades Recientes -->
        <div class="content-section activities-section">
            <div class="section-header">
                <h2 class="section-title">
                    <i class="fas fa-clock"></i>
                    Actividades Recientes
                </h2>
                <p class="section-subtitle">Ultimas acciones realizadas en el sistema</p>
            </div>
            <div class="activities-list">
                @if (Model.ActividadesRecientes != null && Model.ActividadesRecientes.Any())
                {
                    @foreach (var actividad in Model.ActividadesRecientes.Take(5))
                    {
                        <div class="activity-item">
                            <div class="activity-avatar">
                                <img src="/imagenes/verycat-cateat.png" alt="Usuario @actividad.FK_IdUsuario" />
                                <div class="activity-status online"></div>
                            </div>
                            <div class="activity-content">
                                <div class="activity-user">Usuario #@actividad.FK_IdUsuario</div>
                                <div class="activity-action">@actividad.Accion - @actividad.Descripcion</div>
                                <div class="activity-time">
                                    <i class="fas fa-clock"></i>
                                    @{
                                        var diferencia = DateTime.Now - actividad.FechaEntrada;
                                        string tiempoRelativo;
                                        if (diferencia.TotalMinutes < 1)
                                            tiempoRelativo = "Hace unos segundos";
                                        else if (diferencia.TotalMinutes < 60)
                                            tiempoRelativo = $"Hace {(int)diferencia.TotalMinutes} min";
                                        else if (diferencia.TotalHours < 24)
                                            tiempoRelativo = $"Hace {(int)diferencia.TotalHours} hora{((int)diferencia.TotalHours > 1 ? "s" : "")}";
                                        else
                                            tiempoRelativo = $"Hace {(int)diferencia.TotalDays} d√≠a{((int)diferencia.TotalDays > 1 ? "s" : "")}";
                                    }
                                    @tiempoRelativo
                                </div>
                            </div>
                            <div class="activity-type @(actividad.Accion.ToLower().Contains("crear") || actividad.Accion.ToLower().Contains("agregar") ? "create" :
                                                                                       actividad.Accion.ToLower().Contains("editar") || actividad.Accion.ToLower().Contains("modificar") ? "edit" :
                                                                                       actividad.Accion.ToLower().Contains("eliminar") || actividad.Accion.ToLower().Contains("suspender") ? "warning" : "info")">
                        <i class="fas fa-@(actividad.Accion.ToLower().Contains("crear") || actividad.Accion.ToLower().Contains("agregar") ? "plus" :
                                                                             actividad.Accion.ToLower().Contains("editar") || actividad.Accion.ToLower().Contains("modificar") ? "edit" :
                                                                             actividad.Accion.ToLower().Contains("eliminar") || actividad.Accion.ToLower().Contains("suspender") ? "exclamation-triangle" : "info-circle")"></i>
                    </div>
                </div>
                                }
                }
                else
                {
                    <div class="no-activities">
                        <i class="fas fa-inbox"></i>
                        <p>No hay actividades recientes</p>
                    </div>
                }
            </div>
            <div class="section-footer">
                <a href="@Url.Action("Index", "Bitacora")" class="view-all-link">
                    <i class="fas fa-list"></i>
                    Ver todas las actividades
                </a>
            </div>
        </div>

        <!-- Acciones Rapidas -->
        @if (puedeCrear)
        {
            <div class="content-section quick-actions-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-bolt"></i>
                        Acciones Rapidas
                    </h2>
                    <p class="section-subtitle">Funciones mas utilizadas</p>
                </div>
                <div class="quick-actions-grid">
                    <a href="@Url.Action("Crear", "Usuarios")" class="quick-action-card primary">
                        <div class="action-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Crear Usuario</div>
                            <div class="action-description">Agregar nuevo usuario al sistema</div>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    <a href="@Url.Action("Crear", "Empresas")" class="quick-action-card secondary">
                        <div class="action-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Registrar Empresa</div>
                            <div class="action-description">Agregar nueva empresa</div>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    <a href="@Url.Action("Crear", "RolPermisos")" class="quick-action-card tertiary">
                        <div class="action-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Asignar Permisos</div>
                            <div class="action-description">Gestionar permisos de usuario</div>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    <a href="@Url.Action("Index", "Empleados")" class="quick-action-card quaternary">
                        <div class="action-icon">
                            <i class="fas fa-users-cog"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Gestionar Empleados</div>
                            <div class="action-description">Ver y editar empleados</div>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    <a href="@Url.Action("Crear", "UsuariosRol")" class="quick-action-card warning">
                        <div class="action-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Asignar Roles</div>
                            <div class="action-description">Asignar Rol a un Usuario</div>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                    <a href="@Url.Action("Index", "Bitacora")" class="quick-action-card info">
                        <div class="action-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Ver Bitacora</div>
                            <div class="action-description">Revisar actividades del sistema</div>
                        </div>
                        <div class="action-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@if (!string.IsNullOrEmpty(ViewBag.Error as string))
{
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i>
        @ViewBag.Error
    </div>
}